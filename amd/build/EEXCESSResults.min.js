define(["jquery","local_eexcess/APIconnector","local_eexcess/iframes"],function(a,b,c){var d="",e=a('<div id="eexcess_container" class="eexcess-wrapper"/>'),f=a("<iframe>"),g=a('<div id="eexcess_button" class="sym-eexcess">'),h=a('<div class="num-result">0</div>'),i=null,j=function(){var b=50,c=3;k.currentFrame=k.currentFrame<c?k.currentFrame+1:0;var d=b*k.currentFrame;a("#eexcess_button").css("background-position","-"+d+"px 0px")},k={interval:null,currentFrame:0,start:function(){this.interval=window.setInterval(j,300)},stop:function(){window.clearInterval(this.interval),a("#eexcess_button").css("background-position","0px 0px")}},l={init:function(a){d=a+"/local/eexcess/dashboard/index.html?rnd="+Math.random(),l._bindControls(),l._createUI()},_createUI:function(){e.appendTo(a("body")),f.attr("src",d),f.attr("id","moodleEEXCESSdashboard"),e.append(f),g.appendTo(a("body")),g.append(h),g.css({position:"fixed"}),h.hide(),f.on("load",function(){c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{selectedChart:"timeline",hideCollections:!0,showLinkImageButton:!0,showLinkItemButton:!0}})})},_bindControls:function(){a("body").on("mouseup",function(b){var c=a(b.target),d=c.parents(".editor_atto_content").length||c.hasClass("editor_atto_content"),e=l._getSelectionText();e&&e.length>3&&!d&&l._query(e)}),g.on("click",function(a){if(g.hasClass("active"))g.removeClass("active"),e.animate({top:"-588px"},300,function(){e.hide()});else{var b=-1!=window.location.href.indexOf("post.php");b?(window.console.log("initializing dashboard to show citationbuttons"),c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{hideCollections:!1,showLinkImageButton:!0,showLinkItemButton:!0,showScreenshotButton:!0}})):(window.console.log("initializing dashboard for content consumption"),c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{hideCollections:!1,showLinkImageButton:!1,showLinkItemButton:!1,showScreenshotButton:!1}})),g.addClass("active"),e.css({visibility:"visible"}),e.show(),e.animate({top:"43px"},300)}}),window.addEventListener("message",function(a){a.data.event&&("eexcess.paragraphEnd"===a.data.event?l._query(a.data.text):"eexcess.newSelection"===a.data.event||"eexcess.queryTriggered"===a.data.event||"eexcess.error"===a.data.event||"eexcess.rating"===a.data.event||"eexcess.newResults"===a.data.event)})},_updateResultNumber:function(a){a>0?(h.empty().append(a),h.show()):(h.empty().append(a),h.hide())},_query:function(a){var d=this;this._detectEntity(a),k.start(),c.sendMsgAll({event:"eexcess.queryTriggered",data:i}),d._updateResultNumber(0),i={numResults:100,contextKeywords:[{text:a,weight:1}]},b.query(i,function(a){k.stop(),d._updateResultNumber(a.data.totalResults),"success"===a.status?c.sendMsgAll({event:"eexcess.newResults",data:{profile:i,result:a.data.result}}):c.sendMsgAll({event:"eexcess.error",data:a.data})})},_getSelectionText:function(){var a="";return window.getSelection?a=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(a=document.selection.createRange().text),a},_detectEntity:function(a){}};return{init:l.init}});