define(["jquery","local_eexcess/APIconnector","local_eexcess/iframes","local_eexcess/namedEntityRecognition"],function(a,b,c,d){var e="",f=a('<div id="eexcess_container" class="eexcess-wrapper"/>'),g=a("<iframe>"),h=a('<div class="sym-eexcess">'),i=a('<div class="num-result">0</div>'),j=null,k={init:function(a){e=a+"/local/eexcess/dashboard/index.html?rnd="+Math.random(),k._bindControls(),k._createUI()},_createUI:function(){f.appendTo(a("body")),g.attr("src",e),f.append(g),h.appendTo(a("body")),h.append(i),i.hide()},_bindControls:function(){a("body").on("mouseup",function(b){var c=a(b.target),d=c.parents(".editor_atto_content").length||c.hasClass("editor_atto_content"),e=k._getSelectionText();e&&e.length>3&&!d&&k._query(e)}),h.on("click",function(){h.hasClass("active")?(h.removeClass("active"),f.hide()):(h.addClass("active"),f.show())}),window.addEventListener("message",function(a){window.console.log(a.data),a.data.event&&("eexcess.paragraphEnd"===a.data.event?k._query(a.data.text):"eexcess.newSelection"===a.data.event?window.console.log(a.data.selection):"eexcess.queryTriggered"===a.data.event||"eexcess.error"===a.data.event||"eexcess.rating"===a.data.event)})},_updateResultNumber:function(a){window.console.log("Number of results:"+a),a>0?(i.empty().append(a),i.show()):(i.empty().append(a),i.hide())},_query:function(a){var d=this;window.console.log("respose from entity detection"),this._detectEntity(a),c.sendMsgAll({event:"eexcess.queryTriggered",data:j}),j={contextKeywords:[{text:a,weight:1}]},b.query(j,function(a){window.console.log("query ended"),window.console.log(a),d._updateResultNumber(a.data.totalResults),"success"===a.status?c.sendMsgAll({event:"eexcess.newResults",data:{profile:j,results:{results:a.data.result}}}):c.sendMsgAll({event:"eexcess.error",data:a.data})})},_getSelectionText:function(){var a="";return window.getSelection?a=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(a=document.selection.createRange().text),a},_detectEntity:function(a){d.entitiesAndCategories([a],function(a){window.console.log(a)})}};return{init:k.init}});