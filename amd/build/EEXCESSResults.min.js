define(["jquery","local_eexcess/APIconnector","local_eexcess/iframes","local_eexcess/namedEntityRecognition"],function(a,b,c,d){var e="",f=a('<div id="eexcess_container" class="eexcess-wrapper"/>'),g=a("<iframe>"),h=a('<div id="eexcess_button" class="sym-eexcess">'),i=a('<div class="num-result">0</div>'),j=null,k=function(){var b=50,c=3;l.currentFrame=l.currentFrame<c?l.currentFrame+1:0;var d=b*l.currentFrame;a("#eexcess_button").css("background-position","-"+d+"px 0px")},l={interval:null,currentFrame:0,start:function(){this.interval=window.setInterval(k,300)},stop:function(){window.clearInterval(this.interval),a("#eexcess_button").css("background-position","0px 0px")}},m={init:function(a){e=a+"/local/eexcess/dashboard/index.html?rnd="+Math.random(),m._bindControls(),m._createUI()},_createUI:function(){f.appendTo(a("body")),g.attr("src",e),f.append(g),h.appendTo(a("body")),h.append(i),i.hide()},_bindControls:function(){a("body").on("mouseup",function(b){var c=a(b.target),d=c.parents(".editor_atto_content").length||c.hasClass("editor_atto_content"),e=m._getSelectionText();e&&e.length>3&&!d&&m._query(e)}),h.on("click",function(){h.hasClass("active")?(h.css({position:"absolute"}),h.removeClass("active"),f.animate({top:"-588px"},300,function(){f.hide()})):(h.addClass("active"),f.show(),f.animate({top:"43px"},300),h.css({position:"fixed"}))}),window.addEventListener("message",function(a){a.data.event&&("eexcess.paragraphEnd"===a.data.event?m._query(a.data.text):"eexcess.newSelection"===a.data.event||"eexcess.queryTriggered"===a.data.event||"eexcess.error"===a.data.event||"eexcess.rating"===a.data.event||"eexcess.newResults"===a.data.event)})},_updateResultNumber:function(a){a>0?(i.empty().append(a),i.show()):(i.empty().append(a),i.hide())},_query:function(a){var d=this;this._detectEntity(a),l.start(),c.sendMsgAll({event:"eexcess.queryTriggered",data:j}),j={contextKeywords:[{text:a,weight:1}]},b.query(j,function(a){l.stop(),d._updateResultNumber(a.data.totalResults),"success"===a.status?c.sendMsgAll({event:"eexcess.newResults",data:{profile:j,results:{results:a.data.result}}}):c.sendMsgAll({event:"eexcess.error",data:a.data})})},_getSelectionText:function(){var a="";return window.getSelection?a=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(a=document.selection.createRange().text),a},_detectEntity:function(a){d.entitiesAndCategories([a],function(a){})}};return{init:m.init}});