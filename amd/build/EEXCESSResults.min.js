define(["jquery","local_eexcess/APIconnector","local_eexcess/iframes","local_eexcess/LOGconnector","local_eexcess/logging","local_eexcess/md5","local_eexcess/paragraphDetection"],function(a,b,c,d,e,f,g){function h(a,b){return f.getHash(a+b)}var i=void 0,j=void 0,k={origin:{clientType:"EEXCESS - Moodle Plugin",clientVersion:"2.4",module:"eexcess",userID:void 0},loggingLevel:0},l="",m=a('<div id="eexcess_container" class="eexcess-wrapper"/>'),n=a("<iframe>"),o=a('<div id="eexcess_button" class="sym-eexcess">'),p=a('<div class="num-result">0</div>'),q=a('<div class = "button-close">'),r=null,s=function(){var b=50,c=3;t.currentFrame=t.currentFrame<c?t.currentFrame+1:0;var d=b*t.currentFrame;a("#eexcess_button").css("background-position","-"+d+"px 0px")},t={interval:null,currentFrame:0,start:function(){this.interval&&this.stop(),this.interval=window.setInterval(s,300)},stop:function(){window.clearInterval(this.interval),a("#eexcess_button").css("background-position","0px 0px")}},u={init:function(a,c,d){j=c,b.init({base_url:d}),k.origin.userID=h(k.origin.clientType,j),l="https://eexcess.github.io/visualization-widgets/Dashboard/";({origin:k.origin,content:{name:"MoodleEExcess"}});u._bindControls(),u._createUI()},_createUI:function(){m.appendTo(a("body")),n.attr("src",l),n.attr("id","moodleEEXCESSdashboard"),m.append(q),m.append(n),console.log(n),n.on("message",function(a){window.console.log("IFRAME'S message to you!"),window.console.log(a)}),o.appendTo(a("body")),o.append(p),o.css({position:"fixed"}),p.hide(),n.on("load",function(){window.console.log("onload iframe"),c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{selectedChart:"timeline",hideCollections:!1,showLinkImageButton:!0,showLinkItemButton:!0,showScreenshotButton:!0}})})},_bindControls:function(){a("body").on("mouseup",function(b){var c=a(b.target),d=c.parents(".editor_atto_content").length||c.hasClass("editor_atto_content"),e=u._getSelectionText();e&&e.length>3&&!d&&u._query(e)}),q.on("click",function(){o.removeClass("active"),m.animate({top:"-588px"},300,function(){m.hide()})}),o.on("click",function(a){o.hasClass("active")?(o.removeClass("active"),m.animate({top:"-588px"},300,function(){m.hide()})):(o.addClass("active"),m.css({visibility:"visible"}),m.show(),m.animate({top:"43px"},300))}),window.addEventListener("message",function(a){a.data.data&&(a.data.data.loggingLevel=k.loggingLevel,a.data.data.origin={},a.data.data.origin.clientType=k.origin.clientType,a.data.data.origin.clientVersion=k.origin.clientVersion,a.data.data.origin.userID=k.origin.userID,a.data.data.queryID=i),a.data.event&&("eexcess.paragraphEnd"===a.data.event?u._query(a.data.text):"eexcess.newSelection"===a.data.event||"eexcess.queryTriggered"===a.data.event||"eexcess.error"===a.data.event||("eexcess.openDashboard"===a.data.event?o.trigger("click"):"eexcess.rating"===a.data.event||("eexcess.log.moduleOpened"===a.data.event?window.console.log("module open event"):"eexcess.log.itemCitedAsImage"==a.data.event?d.sendLog(d.interactionType.itemCitedAsImage,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsText"==a.data.event?d.sendLog(d.interactionType.itemCitedAsText,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsHyperlink"==a.data.event?d.sendLog(d.interactionType.itemCitedAsHyperlink,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleOpened"==a.data.event?d.sendLog(d.interactionType.moduleOpened,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleClosed"==a.data.event?d.sendLog(d.interactionType.moduleClosed,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleStatisticsCollected"==a.data.event?d.sendLog(d.interactionType.moduleStatisticsCollected,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemRated"==a.data.event?d.sendLog(d.interactionType.itemRated,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemOpened"==a.data.event?d.sendLog(d.interactionType.itemOpened,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemClosed"==a.data.event?d.sendLog(d.interactionType.itemClosed,a.data.data,function(a){window.console.log(a)}):(window.console.log("unknown event recieved!"),window.console.log(a.data)))))})},_updateResultNumber:function(a){a>0?(p.empty().append(a),p.show()):(p.empty().append(a),p.hide())},_query:function(a){var d=this;d._updateResultNumber(0),g.paragraphToQuery(a,function(e){window.console.log("pdetect"),window.console.log(e),r=e.query&&e.query.contextKeywords.length>0?{numResults:100,contextKeywords:e.query.contextKeywords}:{numResults:100,contextKeywords:[{text:a,weight:1}]},c.sendMsgAll({event:"eexcess.queryTriggered",data:r}),t.start(),b.query(r,function(a){t.stop(),i=a.data.queryID,d._updateResultNumber(a.data.totalResults),"success"===a.status?c.sendMsgAll({event:"eexcess.newResults",data:{profile:r,result:a.data.result}}):c.sendMsgAll({event:"eexcess.error",data:a.data})})})},_getSelectionText:function(){var a="";return window.getSelection?a=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(a=document.selection.createRange().text),a}};return{init:u.init}});