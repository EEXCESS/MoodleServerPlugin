define(["jquery","local_eexcess/APIconnector","local_eexcess/iframes","local_eexcess/LOGconnector","local_eexcess/logging","local_eexcess/md5","local_eexcess/paragraphDetection"],function(a,b,c,d,e,f,g){function h(a,b){return f.getHash(a+b)}var i=void 0,j=void 0,k=void 0,l=!1,m={origin:{clientType:"EEXCESS - Moodle Plugin",clientVersion:"2.4",module:"eexcess",userID:void 0},loggingLevel:0},n="",o=a('<div id="eexcess_container" class="eexcess-wrapper"/>'),p=a("<iframe>"),q=a('<div id="eexcess_button" class="sym-eexcess">'),r=a('<div class="num-result">0</div>'),s=a('<div class = "button-close">'),t=null,u=function(){var b=50,c=3;v.currentFrame=v.currentFrame<c?v.currentFrame+1:0;var d=b*v.currentFrame;a("#eexcess_button").css("background-position","-"+d+"px 0px")},v={interval:null,currentFrame:0,start:function(){this.interval&&this.stop(),this.interval=window.setInterval(u,300)},stop:function(){window.clearInterval(this.interval),a("#eexcess_button").css("background-position","0px 0px")}},w={init:function(a,c,d,e){i=e,k=c,b.init({base_url:d}),m.origin.userID=h(m.origin.clientType,k),n="https://eexcess.github.io/visualization-widgets/Dashboard/";({origin:m.origin,content:{name:"MoodleEExcess"}});w._bindControls(),w._createUI()},_createUI:function(){o.appendTo(a("body")),p.attr("src",n),p.attr("id","moodleEEXCESSdashboard"),o.append(s),o.append(p),console.log(p),q.appendTo(a("body")),q.append(r),q.css({position:"fixed"}),r.hide(),p.on("load",function(){window.console.log("onload iframe"),l||c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{selectedChart:"timeline",hideCollections:!1,showLinkImageButton:!1,showLinkItemButton:!1,showScreenshotButton:!1}})})},_bindControls:function(){a("body").on("mouseup",function(b){var c=a(b.target),d=c.parents(".editor_atto_content").length||c.hasClass("editor_atto_content"),e=w._getSelectionText();e&&e.length>3&&!d&&w._query(e)}),s.on("click",function(){q.removeClass("active"),o.animate({top:"-588px"},300,function(){o.hide()})}),q.on("click",function(a){q.hasClass("active")?(q.removeClass("active"),o.animate({top:"-588px"},300,function(){o.hide()})):(q.addClass("active"),o.css({visibility:"visible"}),o.show(),o.animate({top:"43px"},300))}),window.addEventListener("message",function(a){a.data.data&&(a.data.data.loggingLevel=m.loggingLevel,a.data.data.origin={},a.data.data.origin.clientType=m.origin.clientType,a.data.data.origin.clientVersion=m.origin.clientVersion,a.data.data.origin.userID=m.origin.userID,a.data.data.queryID=j),a.data.event&&("eexcess.paragraphEnd"===a.data.event?w._query(a.data.text):"eexcess.newSelection"===a.data.event||"eexcess.queryTriggered"===a.data.event||"eexcess.error"===a.data.event||("eexcess.openDashboard"===a.data.event?q.trigger("click"):"eexcess.newDashboardSettings"===a.data.event?(window.console.log(a.data),l=!0,c.sendMsgAll(a.data)):"eexcess.rating"===a.data.event||("eexcess.log.moduleOpened"===a.data.event?window.console.log("module open event"):"eexcess.log.itemCitedAsImage"==a.data.event?d.sendLog(d.interactionType.itemCitedAsImage,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsText"==a.data.event?d.sendLog(d.interactionType.itemCitedAsText,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsHyperlink"==a.data.event?d.sendLog(d.interactionType.itemCitedAsHyperlink,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleOpened"==a.data.event?d.sendLog(d.interactionType.moduleOpened,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleClosed"==a.data.event?d.sendLog(d.interactionType.moduleClosed,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleStatisticsCollected"==a.data.event?d.sendLog(d.interactionType.moduleStatisticsCollected,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemRated"==a.data.event?d.sendLog(d.interactionType.itemRated,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemOpened"==a.data.event?d.sendLog(d.interactionType.itemOpened,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemClosed"==a.data.event?d.sendLog(d.interactionType.itemClosed,a.data.data,function(a){window.console.log(a)}):(window.console.log("unknown event recieved!"),window.console.log(a.data)))))})},_updateResultNumber:function(a){a>0?(r.empty().append(a),r.show()):(r.empty().append(a),r.hide())},_query:function(a){var d=this;d._updateResultNumber(0),g.paragraphToQuery(a,function(e){window.console.log("pdetect"),window.console.log(e),t=e.query&&e.query.contextKeywords.length>0?{numResults:100,contextKeywords:e.query.contextKeywords}:{numResults:100,contextKeywords:[{text:a,weight:1}]},window.console.log(i),t.interests=i,c.sendMsgAll({event:"eexcess.queryTriggered",data:t}),v.start(),b.query(t,function(a){v.stop(),j=a.data.queryID,d._updateResultNumber(a.data.totalResults),"success"===a.status?c.sendMsgAll({event:"eexcess.newResults",data:{profile:t,result:a.data.result}}):c.sendMsgAll({event:"eexcess.error",data:a.data})})})},_getSelectionText:function(){var a="";return window.getSelection?a=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(a=document.selection.createRange().text),a}};return{init:w.init}});