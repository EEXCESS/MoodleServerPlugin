define(["jquery","local_eexcess/APIconnector","local_eexcess/iframes","local_eexcess/LOGconnector","local_eexcess/logging","local_eexcess/md5","local_eexcess/paragraphDetection"],function(a,b,c,d,e,f,g){function h(a,b){return f.getHash(a+b)}var i=void 0,j=void 0,k=!1,l={origin:{clientType:"EEXCESS - Moodle Plugin",clientVersion:"2.4",module:"eexcess",userID:void 0},loggingLevel:0},m="",n=a('<div id="eexcess_container" class="eexcess-wrapper"/>'),o=a("<iframe>"),p=a('<div id="eexcess_button" class="sym-eexcess">'),q=a('<div class="num-result">0</div>'),r=a('<div class = "button-close">'),s=null,t=function(){var b=50,c=3;u.currentFrame=u.currentFrame<c?u.currentFrame+1:0;var d=b*u.currentFrame;a("#eexcess_button").css("background-position","-"+d+"px 0px")},u={interval:null,currentFrame:0,start:function(){this.interval&&this.stop(),this.interval=window.setInterval(t,300)},stop:function(){window.clearInterval(this.interval),a("#eexcess_button").css("background-position","0px 0px")}},v={init:function(a,c,d){j=c,b.init({base_url:d}),l.origin.userID=h(l.origin.clientType,j),m="https://eexcess.github.io/visualization-widgets/Dashboard/";({origin:l.origin,content:{name:"MoodleEExcess"}});v._bindControls(),v._createUI()},_createUI:function(){n.appendTo(a("body")),o.attr("src",m),o.attr("id","moodleEEXCESSdashboard"),n.append(r),n.append(o),console.log(o),p.appendTo(a("body")),p.append(q),p.css({position:"fixed"}),q.hide(),o.on("load",function(){window.console.log("onload iframe"),k||c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{selectedChart:"timeline",hideCollections:!1,showLinkImageButton:!1,showLinkItemButton:!1,showScreenshotButton:!1}})})},_bindControls:function(){a("body").on("mouseup",function(b){var c=a(b.target),d=c.parents(".editor_atto_content").length||c.hasClass("editor_atto_content"),e=v._getSelectionText();e&&e.length>3&&!d&&v._query(e)}),r.on("click",function(){p.removeClass("active"),n.animate({top:"-588px"},300,function(){n.hide()})}),p.on("click",function(a){p.hasClass("active")?(p.removeClass("active"),n.animate({top:"-588px"},300,function(){n.hide()})):(p.addClass("active"),n.css({visibility:"visible"}),n.show(),n.animate({top:"43px"},300))}),window.addEventListener("message",function(a){a.data.data&&(a.data.data.loggingLevel=l.loggingLevel,a.data.data.origin={},a.data.data.origin.clientType=l.origin.clientType,a.data.data.origin.clientVersion=l.origin.clientVersion,a.data.data.origin.userID=l.origin.userID,a.data.data.queryID=i),a.data.event&&("eexcess.paragraphEnd"===a.data.event?v._query(a.data.text):"eexcess.newSelection"===a.data.event||"eexcess.queryTriggered"===a.data.event||"eexcess.error"===a.data.event||("eexcess.openDashboard"===a.data.event?p.trigger("click"):"eexcess.newDashboardSettings"===a.data.event?(window.console.log(a.data),k=!0,c.sendMsgAll(a.data)):"eexcess.rating"===a.data.event||("eexcess.log.moduleOpened"===a.data.event?window.console.log("module open event"):"eexcess.log.itemCitedAsImage"==a.data.event?d.sendLog(d.interactionType.itemCitedAsImage,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsText"==a.data.event?d.sendLog(d.interactionType.itemCitedAsText,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsHyperlink"==a.data.event?d.sendLog(d.interactionType.itemCitedAsHyperlink,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleOpened"==a.data.event?d.sendLog(d.interactionType.moduleOpened,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleClosed"==a.data.event?d.sendLog(d.interactionType.moduleClosed,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleStatisticsCollected"==a.data.event?d.sendLog(d.interactionType.moduleStatisticsCollected,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemRated"==a.data.event?d.sendLog(d.interactionType.itemRated,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemOpened"==a.data.event?d.sendLog(d.interactionType.itemOpened,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemClosed"==a.data.event?d.sendLog(d.interactionType.itemClosed,a.data.data,function(a){window.console.log(a)}):(window.console.log("unknown event recieved!"),window.console.log(a.data)))))})},_updateResultNumber:function(a){a>0?(q.empty().append(a),q.show()):(q.empty().append(a),q.hide())},_query:function(a){var d=this;d._updateResultNumber(0),g.paragraphToQuery(a,function(e){window.console.log("pdetect"),window.console.log(e),s=e.query&&e.query.contextKeywords.length>0?{numResults:100,contextKeywords:e.query.contextKeywords}:{numResults:100,contextKeywords:[{text:a,weight:1}]},c.sendMsgAll({event:"eexcess.queryTriggered",data:s}),u.start(),b.query(s,function(a){u.stop(),i=a.data.queryID,d._updateResultNumber(a.data.totalResults),"success"===a.status?c.sendMsgAll({event:"eexcess.newResults",data:{profile:s,result:a.data.result}}):c.sendMsgAll({event:"eexcess.error",data:a.data})})})},_getSelectionText:function(){var a="";return window.getSelection?a=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(a=document.selection.createRange().text),a}};return{init:v.init}});