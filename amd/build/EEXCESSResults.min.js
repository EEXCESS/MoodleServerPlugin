define(["jquery","block_eexcess/APIconnector","block_eexcess/iframes","block_eexcess/md5","block_eexcess/paragraphDetection"],function(a,b,c,d,e){function f(a,b){return d.getHash(a+b)}var g,h=!1,i=void 0,j=void 0,k=void 0,l=void 0,m=void 0,n={},o={module:"EEXCESS - Moodle Plugin searchBar",clientType:"EEXCESS - Moodle Plugin",clientVersion:"1.0",userID:"undefined"},p=a('<div class = "search-bar-div">'),q=a("<iframe>"),r="",s=null,t={init:function(c,d,e,g,h,n){i=h,j=n,k=e,l=c,o.userID=f(o.clientType,l),b.init({origin:o}),m=d,r="https://rawgit.com/megamuf/c4-for-moodle-plugin/master/examples/searchBar_Paragraphs/index.html",t._bindControls(),t._createUI(),1===g&&a(".search-bar-div").addClass("active")},_createUI:function(){p.appendTo(a("body")),p.append(q),q.attr("src",r),q.attr("class","search-bar")},_bindControls:function(){a("body").on("mouseup",function(b){var c=a(b.target),d=c.parents(".editor_atto_content").length||c.hasClass("editor_atto_content"),e=t._getSelectionText();e&&e.length>3&&!d&&t._query(e)}),a(".show-hide-bar").on("click",function(){var b;a(".search-bar-div").hasClass("active")?(a(".search-bar-div").removeClass("active"),b=!1,a(this).text(i)):(a(".search-bar-div").addClass("active"),b=!0,a(this).text(j)),a.ajax({url:M.cfg.wwwroot+"/blocks/eexcess/search_bar_status.php",type:"POST",data:{status:b}})}),window.addEventListener("message",function(a){a.data.event&&(a.data.data&&(a.data.data.origin=o),"eexcess.paragraphEnd"===a.data.event?t._query(a.data.text):"eexcess.newSelection"===a.data.event||"eexcess.queryTriggered"===a.data.event||("attoEditorOpened"===a.data.event?(c.sendMsgAll({event:"attoEditorOpened",data:""}),h=!0):"eexcess.error"===a.data.event||("eexcess.searchBarhei"===a.data.event?(g=a.data.data,600==p[0].clientHeight?(p.css("height","600px"),h&&c.sendMsgAll({event:"attoEditorOpened",data:""})):(p.css("height",g+"px"),h&&c.sendMsgAll({event:"attoEditorOpened",data:""}))):"eexcess.openResultsBar"===a.data.event?p.css("height","600px"):"eexcess.closeResultsBar"===a.data.event?p.css("height",g+"px"):"dashboardOpened"===a.data.event?h?(c.sendMsgAll({event:"attoEditorOpened",data:""}),c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{selectedChart:"timeline",hideCollections:!1,showLinkImageButton:!0,showLinkItemButton:!0,showScreenshotButton:!0,origin:o}})):c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{selectedChart:"timeline",hideCollections:!1,showLinkImageButton:!1,showLinkItemButton:!1,showScreenshotButton:!1,origin:o}}):"facetScapeOpened"===a.data.event?h&&c.sendMsgAll({event:"attoEditorOpened",data:""}):"searchBarOpened"===a.data.event?(c.sendMsgAll({event:"interests",data:k}),n.origin=o,n.baseUrl=m,c.sendMsgAll({event:"apiSettings",data:n})):"eexcess.rating"===a.data.event||"eexcess.linkItemClicked"===a.data.event||("eexcess.log.itemCitedAsImage"===a.data.event?b.sendLog(b.logInteractionType.itemCitedAsImage,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsText"===a.data.event?b.sendLog(b.logInteractionType.itemCitedAsText,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsHyperlink"===a.data.event&&b.sendLog(b.logInteractionType.itemCitedAsHyperlink,a.data.data,function(a){window.console.log(a)})))))})},_query:function(a){e.paragraphToQuery(a,function(b){s=b.query&&b.query.contextKeywords.length>0?{contextKeywords:b.query.contextKeywords}:{contextKeywords:[{text:a,weight:1}]},s.origin=o,c.sendMsgAll({event:"eexcess.queryTriggered",data:s})})},_getSelectionText:function(){var a="";return window.getSelection?a=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(a=document.selection.createRange().text),a}};return{init:t.init}});