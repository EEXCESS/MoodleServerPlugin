define(["jquery","local_eexcess/APIconnector","local_eexcess/iframes","local_eexcess/md5","local_eexcess/paragraphDetection"],function(a,b,c,d,e){function f(a,b){return d.getHash(a+b)}var g=void 0,h=void 0,i=void 0,j=!1,k={clientType:"EEXCESS - Moodle Plugin",clientVersion:"1.0",userID:"undefined",module:"eexcess"},l="",m=a('<div id="eexcess_container" class="eexcess-wrapper"/>'),n=a("<iframe>"),o=a('<div id="eexcess_button" class="sym-eexcess">'),p=a('<div class="num-result">0</div>'),q=a('<div class = "button-close">'),r=null,s=function(){var b=50,c=3;t.currentFrame=t.currentFrame<c?t.currentFrame+1:0;var d=b*t.currentFrame;a("#eexcess_button").css("background-position","-"+d+"px 0px")},t={interval:null,currentFrame:0,start:function(){this.interval&&this.stop(),this.interval=window.setInterval(s,300)},stop:function(){window.clearInterval(this.interval),a("#eexcess_button").css("background-position","0px 0px")}},u={init:function(a,c,d,e){g=e,i=c,k.userID=f(k.clientType,i),b.init({origin:k,base_url:d}),l="https://eexcess.github.io/visualization-widgets/Dashboard/",u._bindControls(),u._createUI()},_createUI:function(){m.appendTo(a("body")),n.attr("src",l),n.attr("id","moodleEEXCESSdashboard"),m.append(q),m.append(n),console.log(n),o.appendTo(a("body")),o.append(p),o.css({position:"fixed"}),p.hide(),n.on("load",function(){j||c.sendMsgAll({event:"eexcess.newDashboardSettings",settings:{selectedChart:"timeline",hideCollections:!1,showLinkImageButton:!1,showLinkItemButton:!1,showScreenshotButton:!1,origin:k}})})},_bindControls:function(){a("body").on("mouseup",function(b){var c=a(b.target),d=c.parents(".editor_atto_content").length||c.hasClass("editor_atto_content"),e=u._getSelectionText();e&&e.length>3&&!d&&u._query(e)}),q.on("click",function(){o.removeClass("active"),m.animate({top:"-588px"},300,function(){m.hide()})}),o.on("click",function(a){o.hasClass("active")?(o.removeClass("active"),m.animate({top:"-588px"},300,function(){m.hide()})):(o.addClass("active"),m.css({visibility:"visible"}),m.show(),m.animate({top:"43px"},300))}),window.addEventListener("message",function(a){a.data.event&&(a.data.data&&(a.data.data.origin=k),"eexcess.paragraphEnd"===a.data.event?(j||(j=!0,window.postMessage({event:"eexcess.newDashboardSettings",settings:{selectedChart:"timeline",hideCollections:!1,showLinkImageButton:!0,showLinkItemButton:!0,showScreenshotButton:!0,origin:k}},"*")),u._query(a.data.text)):"eexcess.newSelection"===a.data.event||"eexcess.queryTriggered"===a.data.event||"eexcess.error"===a.data.event||("eexcess.openDashboard"===a.data.event?o.trigger("click"):"eexcess.newDashboardSettings"===a.data.event?(j=!0,c.sendMsgAll(a.data)):"eexcess.rating"===a.data.event||("eexcess.log.itemCitedAsImage"==a.data.event?b.sendLog(b.logInteractionType.itemCitedAsImage,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsText"==a.data.event?b.sendLog(b.logInteractionType.itemCitedAsText,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemCitedAsHyperlink"==a.data.event?b.sendLog(b.logInteractionType.itemCitedAsHyperlink,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleOpened"==a.data.event?b.sendLog(b.logInteractionType.moduleOpened,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleClosed"==a.data.event?b.sendLog(b.logInteractionType.moduleClosed,a.data.data,function(a){window.console.log(a)}):"eexcess.log.moduleStatisticsCollected"==a.data.event?b.sendLog(b.logInteractionType.moduleStatisticsCollected,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemRated"==a.data.event?b.sendLog(b.logInteractionType.itemRated,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemOpened"==a.data.event?b.sendLog(b.logInteractionType.itemOpened,a.data.data,function(a){window.console.log(a)}):"eexcess.log.itemClosed"==a.data.event&&b.sendLog(b.logInteractionType.itemClosed,a.data.data,function(a){window.console.log(a)}))))})},_updateResultNumber:function(a){a>0?(p.empty().append(a),p.show()):(p.empty().append(a),p.hide())},_query:function(a){var d=this;d._updateResultNumber(0),e.paragraphToQuery(a,function(e){r=e.query&&e.query.contextKeywords.length>0?{numResults:100,contextKeywords:e.query.contextKeywords}:{numResults:100,contextKeywords:[{text:a,weight:1}]},r.interests=g,r.origin=k,c.sendMsgAll({event:"eexcess.queryTriggered",data:r}),t.start(),b.query(r,function(a){t.stop(),h=a.data.queryID,d._updateResultNumber(a.data.totalResults),"success"===a.status?c.sendMsgAll({event:"eexcess.newResults",data:{profile:r,result:a.data.result}}):c.sendMsgAll({event:"eexcess.error",data:a.data})})})},_getSelectionText:function(){var a="";return window.getSelection?a=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(a=document.selection.createRange().text),a}};return{init:u.init}});