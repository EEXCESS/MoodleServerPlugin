define(["jquery","c4/namedEntityRecognition"],function(a,b){var c={prefix:"eexcess",classname:"eexcess_detected_par"},d=function(a){"undefined"==typeof a&&(a=document.body);for(var b=[],c=document.createTreeWalker(a,NodeFilter.SHOW_TEXT),d=c.nextNode();d;){var e=d.nodeValue.search(/\S+/),f=d.parentNode.nodeName,g="SCRIPT"!==f,h="STYLE"!==f,i="NOSCRIPT"!==f,j=d.nodeValue.length>40;-1!==e&&g&&h&&i&&j?(-1===b.indexOf(d.parentNode)&&b.push(d.parentNode),c.currentNode=d.parentNode,d=c.nextSibling()):d=c.nextNode()}return b},e=function(a){var b=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT),c=a;for(b.currentNode=c;c=b.previousNode();)if(0===c.nodeName.indexOf("H"))return c;return null},f=function(b,d){for(var f="",g=0;g<b.length;g++)f+=a(b[g]).text();return a(b).wrapAll('<div id="'+c.prefix+"_par_"+d+'" data-idx="'+d+'" class="'+c.classname+'" style="border:1px solid green"></div>'),{elements:b,headline:a(e(b[0])).text(),content:f,multi:b.length>1,id:c.prefix+"_par_"+d}},g={setTimer:function(a,b){"undefined"==typeof b&&(b=100),this.callback=a,this.timeoutID=window.setTimeout(a,b)},clearTimer:function(){window.clearTimeout(this.timeoutID),delete this.timeoutID}};return{init:function(b){c=a.extend(c,b)},getSettings:function(){return c},getParagraphs:function(b){for(var c=d(b),e=[],g=0,h=0;h<c.length;h++){for(var i=c[h].nextSibling,j=!0,k=h,l=[];null!==i;)if("#text"!==i.nodeName){var m=a.inArray(i,c,k);m>-1?(k=m,l.push(c[k]),j=!1,i=i.nextSibling):i=null}else i=i.nextSibling;if(j){var n=a(c[h]).text();n.length>100&&n.indexOf(".")>-1&&(e.push(f([c[h]],g)),g++)}else l.unshift(c[h]),e.push(f(l,g)),g++,h=k}return e},enrichParagraphs:function(a,c){return a.length!==c.length?void console.log("paragraphs do not match statistic"):(a.forEach(function(a,d){var e=c[d];if(a.id!==e.id)for(var f=0;f<c.length;f++)if(a.id===c[f].id){e=c[f];break}a.entities=b.entitiesFromStatistic(e.statistic)}),a)},getSelection:function(b){var d={selection:document.getSelection().toString()};if("undefined"!=typeof b&&d.selection.length>0){var e=a(window.getSelection().getRangeAt(0).commonAncestorContainer).parents("."+c.classname);if(1===e.length){var f=e[0].dataset.idx;f&&f<b.length&&e[0].id===b[f].id&&b[f].entities&&(d.entities=b[f].entities)}else e.length>1&&console.log("multiple paragraphs")}return d},augmentLinks:function(b,c,d,e,f){var h=a('<img src="'+c+'" style="cursor:pointer;width:30px;" />');h.click(function(){var b={contextKeywords:[{weight:1,text:a(this).data("query")}]};if("undefined"!=typeof f){var c=a(this).data("paragraphID"),e=a(this).data("idx");f[e].id===c&&(b.contextNamedEntities=f[e].entities)}d(b)}).hover(function(){g.clearTimer()},function(){a(this).hide()}).css("position","absolute").css("z-index",9999).mouseleave(function(){a(this).hide()}).hide(),a("body").append(h);var i=25,j=-2;b.find("a").each(function(){var b=a(this);if(b.text().length>3){var c=a('<div style="display:inline;"></div>');c.mouseenter(function(c){console.log("mouseenter");var d=b.parents("."+e);g.clearTimer(),h.data("query",b.text()),h.data("paragraphID",d[0].id),h.data("idx",d[0].dataset.idx);var f=a(this),k=f.offset();h.css("top",k.top-f.height()+j+"px").css("left",k.left-i+"px").show()}),c.mouseleave(function(){g.setTimer(function(){h.hide()})}),b.wrap(c)}})}}});