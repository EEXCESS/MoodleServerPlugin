define(["jquery","block_eexcess/namedEntityRecognition","block_eexcess/guessLanguage"],function(a,b,c){var d={img1:null,img2:null,img3:null,img4:null,img5:null,img6:null,selection:null,selectedElement:null,framecords:null},e=function(b){if(""!==window.getSelection().toString()){d.selection=window.getSelection(),d.selectedElements=h(d.selection),d.firstSelectedElement=d.selection.anchorNode.parentElement,d.lastSelectedElement=d.selection.extentNode.parentElement,d.selectedElement=d.selection.extentNode.parentElement,d.selection=d.selection.toString();var c=b.pageX,e=b.pageY+10;a(window).width()-145<=b.pageX&&(c=b.pageX-145),a(window).height()-45<=b.pageY&&(e=b.pageY-45),d.img1.css("top",e).css("left",c).fadeIn("fast"),d.img2.css("top",e).css("left",c+35).fadeIn("fast"),d.img3&&(d.img4.fadeOut("fast"),d.img3.css("top",e).css("left",c+70).fadeIn("fast")),window.getSelection().toString().split(" ").length<=4?(d.img5.css("top",e).css("left",c+105).fadeIn("fast"),d.img6.fadeOut("fast")):(d.img6.css("top",e).css("left",c+105).fadeIn("fast"),d.img5.fadeOut("fast"))}else d.img1.fadeOut("fast"),d.img2.fadeOut("fast"),d.img3&&d.img3.fadeOut("fast"),d.img4&&d.img4.fadeOut("fast"),d.img5&&d.img5.fadeOut("fast"),d.img6&&d.img6.fadeOut("fast")},f=[],g={prefix:"eexcess",classname:"eexcess_detected_par",img_PATH:"img/"},h=function(b){for(var c,d=b.getRangeAt(0),e=d.commonAncestorContainer.hasChildNodes()?d.commonAncestorContainer.getElementsByTagName("*"):b,f={left:0,width:0,selectionText:""},g=0;c=e[g];g++)if(b.containsNode(c,!0)){var h=c;h&&a(h).width()>=0&&(f.selectionText+=a(h).text(),f.width<=0&&(f.width=a(h).width()),f.left<=0&&(f.left=a(h).offset().left),a(h).width()>f.width&&(f.width=a(h).width()),a(h).offset().left<f.left&&(f.left=a(h).offset().left))}return f},i=function(a){"undefined"==typeof a&&(a=document.body);for(var b=[],c=document.createTreeWalker(a,NodeFilter.SHOW_TEXT),d=c.nextNode();d;){var e=d.nodeValue.search(/\S+/),f=d.parentNode.nodeName,g="SCRIPT"!==f,h="STYLE"!==f,i="NOSCRIPT"!==f,j=d.nodeValue.length>40;-1!==e&&g&&h&&i&&j?(-1===b.indexOf(d.parentNode)&&b.push(d.parentNode),c.currentNode=d.parentNode,d=c.nextSibling()):d=c.nextNode()}return b},j=function(a){var b=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT),c=a;for(b.currentNode=c;c=b.previousNode();)if(0===c.nodeName.indexOf("H"))return c;return null},k=function(b,c){for(var d="",e=0;e<b.length;e++)d+=a(b[e]).text();return a(b).wrapAll('<div id="'+g.prefix+"_par_"+c+'" data-idx="'+c+'" class="'+g.classname+'"></div>'),{elements:b,headline:a(j(b[0])).text(),content:d,multi:b.length>1,id:g.prefix+"_par_"+c}},l={setTimer:function(a,b){"undefined"==typeof b&&(b=100),this.callback=a,this.timeoutID=window.setTimeout(a,b)},clearTimer:function(){window.clearTimeout(this.timeoutID),delete this.timeoutID}};return{init:function(b){g=a.extend(g,b)},getSettings:function(){return g},getParagraphs:function(b,c){"undefined"==typeof b&&(b=document),"undefined"==typeof c&&(c={});for(var d=i(b),e=[],g=0,h=0;h<d.length;h++){for(var j=d[h].nextSibling,l=!0,m=h,n=[];null!==j;)if("#text"!==j.nodeName){var o=a.inArray(j,d,m);o>-1?(m=o,n.push(d[m]),l=!1,j=j.nextSibling):j=null}else j=j.nextSibling;if(l){if(c.fast||a(d[h]).is(":visible")){var p=a(d[h]).text();if(p.length>100&&p.indexOf(".")>-1){var q=k([d[h]],g);c.addSubparagraphs&&(q.subparagraphs=[{el:d[h],text:a(d[h]).text()}]),e.push(q),g++}}}else if(c.fast||a(d[h]).is(":visible")){n.unshift(d[h]);var q=k(n,g);c.addSubparagraphs&&(q.subparagraphs=[],n.forEach(function(b){q.subparagraphs.push({el:b,text:a(b).text()})})),e.push(q),g++,h=m}}return f=e,e},paragraphToQuery:function(d,e,f,g){var h=function(a){var b={contextKeywords:[]},c=[],f=function(a,b){if(a=a.trim(),a.length<b)return!1;var c=a.charAt(0);return c===c.toUpperCase()&&c!==c.toLowerCase()?a:!1},g=function(a,b){for(var c=100,d=.85,e=.5,f=3,g=function(a,b){var c={nodes:[],vocabulary:[]},d=a.split(/[^a-zA-ZäöüÄÖÜßÀàÂâÆæÇçÈèÉéÊêËëÎîÏïÔôŒœÙùÛûŸÿ]/),e=[];d.forEach(function(a){var b=a.charAt(0),c="OTH";b===b.toUpperCase()&&b!==b.toLowerCase()&&a.length>3&&(c="NN");var d=[];d.push(a),d.push(c),e.push(d)});for(var f=0;f<e.length;++f)if("NN"===e[f][1]){var g=e[f][0],h=c.vocabulary.indexOf(g);-1===h&&(h=c.vocabulary.length,c.vocabulary.push(g),c.nodes[h]={adjacent:new Set,weightOld:1,weightNew:0});for(var i=f+1;f+b>i&&i<e.length;++i)if("NN"===e[i][1]){var j=e[i][0];if(g===j)continue;var k=c.vocabulary.indexOf(j);-1===k&&(k=c.vocabulary.length,c.vocabulary.push(j),c.nodes[k]={adjacent:new Set,weightOld:1,weightNew:0}),c.nodes[h].adjacent.add(k),c.nodes[k].adjacent.add(h)}}return c},h=function(a,b){for(var c=0,d=0;d<a.nodes.length;d++){var e=0;a.nodes[d].adjacent.forEach(function(b,c,d){e+=a.nodes[b].weightOld/a.nodes[b].adjacent.size}),a.nodes[d].weightNew=1-b+b*e}for(var d=0;d<a.nodes.length;d++){var f=Math.abs(a.nodes[d].weightNew-a.nodes[d].weightOld);f>c&&(c=f),a.nodes[d].weightOld=a.nodes[d].weightNew,a.nodes[d].weightNew=0}return c},i=function(a,b){for(var c=[],d=0;d<a.nodes.length;d++){var e=a.nodes[d];c.push({term:a.vocabulary[d],weight:e.weightOld})}c.sort(function(a,b){return b.weight-a.weight});for(var f=new Set,d=0;b>d&&d<c.length;d++)f.add(c[d].term);return f},j=g(a,f),k=0;c>k;k++){var l=h(j,d);if(l<=e/j.nodes.length)break}return i(j,b)};a=a.trim();var h=a.split(/[^a-zA-ZäöüÄÖÜßÀàÂâÆæÇçÈèÉéÊêËëÎîÏïÔôŒœÙùÛûŸÿ]/);if(h.length<5)return b.contextKeywords.push({text:a}),c[a]=[d.indexOf(a)],void e({query:b,offsets:c});var i=a.split(/[.!?]/),j=new Set;i.forEach(function(a){for(var b=a.split(/[^a-zA-ZäöüÄÖÜßÀàÂâÆæÇçÈèÉéÊêËëÎîÏïÔôŒœÙùÛûŸÿ]/),c=0;c<b.length;c++){var d=f(b[c],3);if(d){var e;for(c++;c<b.length&&(e=f(b[c],2));)d+=" "+e,c++;d.length>4&&j.add(d)}}});var k=[];j.forEach(function(a){k.push(a)}),j=[],k.sort(function(a,b){return a.length<b.length?-1:a.length>b.length?1:0});for(var l=0;l<k.length;++l){for(var m=!1,n=l+1;n<k.length;++n)-1!==k[n].indexOf(k[l])&&(m=!0);m||j.push(k[l])}if(j.length>10){var o=new Set,p=g(a,10);p.forEach(function(a){for(var b=0;b<j.length;++b)if(-1!==j[b].indexOf(a)){o.add(j[b]);break}}),j=o.size>3?o:new Set(j)}else j=new Set(j);if(0===j.size)for(var q=0,l=0;10>q&&l<h.length;l++){var r=h[l].trim();r.length>3&&(q++,j.add(r))}j.forEach(function(a){b.contextKeywords.push({text:a});var e=d.indexOf(a);for(c[a]=[];-1!==e;)c[a].push(e),e=d.indexOf(a,e+a.length);if(0===c[a].length){var f=a.split(" ")[0];for(e=d.indexOf(f);-1!==e;)c[a].push(e),e=d.indexOf(f,e+f.length)}}),e({query:b,offsets:c})};c.detect(d,function(c){if("en"===c||"de"===c){"undefined"==typeof f&&(f=1),"undefined"==typeof g&&(g="");var i={paragraphs:[{id:f,headline:g,content:d}],language:c};b.entitiesAndCategories(i,function(b){if("success"===b.status){var c={contextKeywords:[]},f=[];if(b.data.paragraphs[0].topic&&"undefined"!=typeof b.data.paragraphs[0].topic&&"undefined"!=typeof b.data.paragraphs[0].topic.text){var g={text:b.data.paragraphs[0].topic.text,uri:b.data.paragraphs[0].topic.entityUri,type:b.data.paragraphs[0].topic.type,isMainTopic:!0};c.contextKeywords.push(g)}a.each(b.data.paragraphs[0].statistic,function(){f[this.key.text]=this.key.offset,this.key.text!==g.text&&c.contextKeywords.push({text:this.key.text,uri:this.key.entityUri,type:this.key.type,isMainTopic:!1})}),0===c.contextKeywords.length?h(d):e({query:c,offsets:f})}else h(d)})}else h(d)})},paragraphsToQueries:function(a,d,e){if(0===a.length)return void d({error:"no paragraphs given"});for(var e=e||"",f=[],g={id:"main",content:"",headline:e},h=0;h<a.length;h++)f.push({id:h,headline:e,content:a[h].text}),g.content+=a[h].text;f.push(g),c.detect(g.content,function(a){if("en"===a||"de"===a){var c={paragraphs:f,language:a};b.entitiesAndCategories(c,function(a){if("success"===a.status){var b,c=function(a,b,c){return{text:a.text,uri:a.entityUri,type:a.type,categories:a.categories||[],frequency:c||1,isMainTopic:b}},e={subs:[],main:{contextKeywords:[],offsets:[]}};a.data.paragraphs.forEach(function(a){"main"===a.id&&a.topic&&"undefined"!=typeof a.topic&&"undefined"!=typeof a.topic.text&&(b=c(a.topic,!0),e.main.contextKeywords.push(b))});var g=0;a.data.paragraphs.forEach(function(a){if("main"!==a.id){var d,h={contextKeywords:[],offsets:[]};a.topic&&"undefined"!=typeof a.topic&&"undefined"!=typeof a.topic.text&&(d=c(a.topic,!0),h.contextKeywords.push(d)),a.statistic.forEach(function(a){var f=[];a.key.offset.forEach(function(a){f.push(a+g)});var i=c(a.key,!1,a.value);if(d&&d.text===a.key.text||(h.offsets[a.key.text]=f,h.contextKeywords.push(i)),!b||b.text!==a.key.text)if(e.main.offsets[a.key.text]){e.main.offsets[a.key.text]=e.main.offsets[a.key.text].concat(f);for(var j=0;j<e.main.contextKeywords.length;j++)if(e.main.contextKeywords[j].uri===a.key.entityUri){e.main.contextKeywords[j].frequency+=a.value;break}}else e.main.offsets[a.key.text]=f,e.main.contextKeywords.push(i)}),e.subs.push(h),g+=f[a.id].content.length}}),d({queries:e})}else d({error:a.data})})}else d({error:"unsupported language: "+a})})},getSelection:function(b){var c={selection:document.getSelection().toString()};if("undefined"!=typeof b&&c.selection.length>0){var d=a(window.getSelection().getRangeAt(0).commonAncestorContainer).parents("."+g.classname);if(1===d.length){var e=d[0].dataset.idx;e&&e<b.length&&d[0].id===b[e].id&&b[e].entities&&(c.entities=b[e].entities)}else d.length>1}return c},augmentLinks:function(b,c,d,e,f){var g=a('<img src="'+c+'" style="cursor:pointer;width:30px;" />');g.click(function(){var b={contextKeywords:[{weight:1,text:a(this).data("query")}]};if("undefined"!=typeof f){var c=a(this).data("paragraphID"),e=a(this).data("idx");f[e].id===c&&(b.contextNamedEntities=f[e].entities)}d(b)}).hover(function(){l.clearTimer()},function(){a(this).hide()}).css("position","absolute").css("z-index",9999).mouseleave(function(){a(this).hide()}).hide(),a("body").append(g);var h=25,i=-2;b.find("a").each(function(){var b=a(this);if(b.text().length>3){var c=a('<div style="display:inline;"></div>');c.mouseenter(function(c){var d=b.parents("."+e);l.clearTimer(),g.data("query",b.text()),g.data("paragraphID",d[0].id),g.data("idx",d[0].dataset.idx);var f=a(this),j=f.offset();g.css("top",j.top-f.height()+i+"px").css("left",j.left-h+"px").show()}),c.mouseleave(function(){l.setTimer(function(){g.hide()})}),b.wrap(c)}})},findFocusedParagraph:function(b){function c(){a(f).each(function(){var b=0,c=0;a(this.elements).each(function(){a(this).width()>b&&(b=a(this).width()),c+=a(this).height()}),this.area=b*c,this.area>q&&(q=this.area)}),a(f).each(function(){this.sizeRelation=this.area/q})}function d(b){var c=new Set,d=a(window).scrollTop()+a(window).height();return a(b).each(function(){var b=a(this.elements[0]).offset().top,e=b+a(this.elements[0]).parent().height();d>=b&&e>=a(window).scrollTop()&&(this.cursorDistance=0,c.add(this))}),c}function e(){var a,b=0;r.forEach(function(c){c.pGotRead=l*c.sizeRelation+m*c.distance+n*c.cursorDistance,c.pGotRead>b&&(b=c.pGotRead,a=c)});var c=new CustomEvent("paragraphFocused",{detail:a});document.dispatchEvent(c)}function g(){r.forEach(function(b){var c=a(b.elements[0]).offset(),d=c.left-a(window).scrollLeft(),e=c.top-a(window).scrollTop();0>e&&(e=a(window).height());var f=Math.sqrt(d*d+e*e);b.distance=1-f/p})}function h(b,c){r.forEach(function(d){var e={x:0,y:0},f=a(d.elements[0]).offset(),g=0,h=0;a(d.elements).each(function(){g+=a(this).height(),h<a(this).width()&&(h=a(this).width())}),e.y=f.top+g,e.x=f.left,d.cursorDistance=1-Math.sqrt(Math.pow(e.x-b,2)+Math.pow(e.y-c,2))/p})}var i,j,k,l=.1,m=1,n=3,o=0,p=Math.sqrt(a(window).height()*a(window).height()+a(window).width()*a(window).width()),q=0;"undefined"!=typeof b&&(f=b),c();var r=d(f);g(),h(0,0),e(),a(document).scroll(function(a){clearTimeout(i),i=setTimeout(function(){n=.2,r=d(f),g(),e()},100)}),a(document).mousemove(function(a){clearTimeout(k),o++,k=setTimeout(function(){o>10&&(n=3,h(a.pageX,a.pageY),e()),o=0},100)}),a(window).resize(function(){clearTimeout(j),j=setTimeout(function(){p=Math.sqrt(a(window).height()*a(window).height()+a(window).width()*a(window).width()),c(),r=d(f),g(),e()},100)})},findFocusedParagraphSimple:function(b){function c(a){var b,c;if(h.forEach(function(a){a.pGotRead=a.distance,(!b||a.pGotRead<b)&&(b=a.pGotRead,c=a)}),c){var d=new CustomEvent("paragraphFocused",{detail:{paragraph:c,trigger:a}});document.dispatchEvent(d)}}function d(b){var c=new Set,d=a(window).scrollTop()+a(window).height();return a(b).each(function(){var b=a(this.elements[0]).offset().top,e=b+a(this.elements[0]).parent().height();d>=b&&e>=a(window).scrollTop()&&c.add(this)}),c}function e(){h.forEach(function(b){var c=a(b.elements[0]).offset(),d=c.left-a(window).scrollLeft(),e=c.top-a(window).scrollTop();0>e&&(e-=a(window).height()),b.distance=Math.sqrt(d*d+e*e)})}var g;"undefined"!=typeof b&&(f=b),a.each(f,function(){var b=this;a(this.elements[0]).parent().click(function(a){var c=new CustomEvent("paragraphFocused",{detail:{paragraph:b,trigger:"click"}});document.dispatchEvent(c)})});var h=d(f);e(),c("init"),a(document).scroll(function(a){clearTimeout(g),g=setTimeout(function(){h=d(f),e(),c("scroll")},100)})},getOffsetMap:function(a){for(var b,c=[],d=0,e=document.createTreeWalker(a,NodeFilter.SHOW_TEXT);b=e.nextNode();)b.nodeValue.length>0&&(c.push({offset:d,el:b}),d+=b.nodeValue.length);return c},deactivateSelectionAugmentation:function(){d.img1.remove(),d.img2.remove(),d.img3.remove(),d.img4.remove(),d.img5.remove(),d.img6.remove(),a(document).unbind("mouseup",e),a("body").has("#gen-para-ex-selected")&&a("#gen-para-ex-selected").remove()},activateSelectionAugmentation:function(b){"function"==typeof b.addKeyword&&(d.img1=a('<div id="add-ex-aug" title="Add this selection as a Keyword-Tag in the SearchBar"></div>').css("position","absolute").css("width","30px").css("height","30px").css("cursor","pointer").css("background-image",'url("'+g.img_PATH+'add.png")').css("background-size","contain").hide(),d.img1.click(function(a){b.addKeyword(d.selection)}),a("body").append(d.img1)),"function"==typeof b.queryFromSelection&&(d.img2=a('<div id="search-ex-aug" title="Search with the (automatically recognised) Named Entities in this selection"></div>').css("position","absolute").css("width","30px").css("height","30px").css("cursor","pointer").css("title",'"button2"').css("background-image",'url("'+g.img_PATH+'search.png")').css("background-size","contain").hide(),d.img2.click(function(a){b.queryFromSelection(d.selection)}),a("body").append(d.img2)),"function"==typeof b.pd&&(d.img3=a('<div id="gen-para-ex-aug" title="Handle this selection as a paragraph"></div>').css("position","absolute").css("width","30px").css("height","30px").css("cursor","pointer").css("background-image",'url("'+g.img_PATH+'gen-para.png")').css("background-size","contain").hide(),d.img3.click(function(c){var e=a(d.firstSelectedElement),f=a(d.lastSelectedElement),g=(a(d.selectedElement),d.selectedElements);e.width()+e.offset().left,f.width()+f.offset().left;0===g.width&&(g.width=e.width(),g.left=e.offset().left,g.selectionText=a(d.selectedElement).text()),a("body").has("#gen-para-ex-selected")&&a("#gen-para-ex-selected").remove();var h=a('<div id="gen-para-ex-selected"></div>').css("position","absolute").css("top",e.offset().top).css("left",g.left).css("width",g.width).css("pointer-events","none").css("height",f.offset().top-e.offset().top+f.height());a("body").append(h),b.pd(h,g.selectionText)}),a("body").append(d.img3),d.img4=a('<div id="gen-para-ex-aug" title="Can not handle this selection as a paragraph"></div>').css("position","absolute").css("width","30px").css("height","30px").css("background-image",'url("'+g.img_PATH+'gen-para-grey.png")').css("background-size","contain").hide(),a("body").append(d.img4)),"function"==typeof b.mainTopic&&(d.img5=a('<div id="main-topic-ex-aug" title="Select as a maintopic"></div>').css("position","absolute").css("width","30px").css("height","30px").css("cursor","pointer").css("title",'"button2"').css("background-image",'url("'+g.img_PATH+'main-topic.png")').css("background-size","contain").hide(),d.img5.click(function(a){b.mainTopic(d.selection)}),a("body").append(d.img5),d.img6=a('<div id="main-topic-grey-ex-aug" title="Selection too long for maintopic"></div>').css("position","absolute").css("width","30px").css("height","30px").css("title",'"button2"').css("background-image",'url("'+g.img_PATH+'main-topic-grey.png")').css("background-size","contain").hide(),a("body").append(d.img6)),a(document).bind("mouseup",e)}}});